#! /usr/bin/env bash
set -o errexit
set -o pipefail

### Check cmd exist
chkcmd "git"
chkcmd "pnpm"

### Check is node project exist
chkfile package.json
chkfile pnpm-lock.yaml

### Check Major version
set +o errexit
pnpm outdated
COMMIT_MSG_BODY="$(pnpm outdated --compatible --format json | jq -cr 'to_entries[] | select( .value.current != .value.latest ) | "- \(.key) \(.value.current) -> \(.value.latest)" ')"
set -o errexit

if ! [ "$COMMIT_MSG_BODY" = "" ]; then
  ### Upgrade packages
  pnpm update

  ### Add to git
  git add package.json
  git add pnpm-lock.yaml
  git commit -m "fix(deps): update all non-major dependencies" -m "$COMMIT_MSG_BODY" -m "by depsup script"
  git push

  ### Check Major version again
  pnpm outdated
fi
