#! /usr/bin/env bash
set -o errexit
set -o pipefail

chkcmd "brew"
chkcmd "curl"
chkcmd "fnm"
chkcmd "git"
chkcmd "jq"
chkcmd "node"
chkcmd "npm"

### Upgrade homebrew apps/clis
cd "$HOME"
brew upgrade

## Update Node.js
LATEST_LTS_VERSION="$(curl -fsSL https://nodejs.org/download/release/index.json | jq -cr 'last( sort_by( .date | split("-") | map(tonumber) ) | .[] | select(.lts) ) | .version')"
CURRENT_LOCAL_VERSION="$(node -v)"
if ! [ "$LATEST_LTS_VERSION" = "$CURRENT_LOCAL_VERSION" ]; then
  printf "Latest Node.js LTS version: \033[1;36m$LATEST_LTS_VERSION\033[0m, local: \033[1;31m$CURRENT_LOCAL_VERSION\033[0m\n"
  fnm install --lts
  fnm default lts-latest
  fnm uninstall "$CURRENT_LOCAL_VERSION"
fi

## Update npm
LATEST_NPM_VERSION="$(npm view npm@latest version)"
CURRENT_NPM_VERSION="$(npm -v)"
if ! [ "$LATEST_NPM_VERSION" = "$CURRENT_NPM_VERSION" ]; then
  printf "Latest npm version: \033[1;36m$LATEST_NPM_VERSION\033[0m, local: \033[1;31m$CURRENT_NPM_VERSION\033[0m\n"
  printf "Installing \033[1;36mnpm $LATEST_NPM_VERSION\033[0m\n"
  npm install --audit false --fund false --loglevel error --progress false --global true npm
  printf "Run \033[1;36mnpm doctor\033[0m\n\n"
  npm doctor
  echo ""
fi

### Sync git projects
cd "$(dirname $0)"
cd "../../"
for PROJECT in $(ls .); do
  cd "$PROJECT"
  if [ -d .git ]; then
    git pull --all --quiet && printf "Sync \033[1m%s\033[0m ok\n" "$PROJECT" &
  fi
  cd "../"
done

wait
